# Claude Quick Reference - JSON-RPC Compatibility Testing

## Project Overview
Setting up dual-blockchain JSON-RPC API compatibility testing between **Cosmos EVM** and **Ethereum (Geth)** to ensure API compatibility and identify differences.

## What We've Accomplished ✅

### 1. Infrastructure Setup
- ✅ **Dual Network Setup**: Both evmd (localhost:8545) and geth (localhost:8547) running with same chain ID (4221)
- ✅ **Docker Containerization**: Proper container setup with volume mounting and network access
- ✅ **Script Organization**: Clean start/stop scripts for both networks in `/scripts` directory

### 2. Blockchain State Preparation  
- ✅ **Initial State Creation**: Generated blockchain state with multiple value transfer transactions
- ✅ **Transaction History**: Created 3 value transfers to establish meaningful blockchain state
- ✅ **Account Setup**: Standard test accounts from local_node.sh with proper balances

### 3. Genesis State Management
- ✅ **Genesis Export**: Successfully exported evmd genesis with transaction state (40,926 bytes)
- ✅ **Genesis Conversion**: Built Go converter to transform cosmos genesis → geth genesis format
- ✅ **State Synchronization**: Both chains now have identical account balances and contract state

### 4. Code Refactoring & Architecture
- ✅ **Package Structure**: Refactored stategen and genesis-converter as packages within simulator
- ✅ **Dependency Management**: Updated to use go-ethereum v1.15.10 throughout
- ✅ **CLI Tools**: Created CLI wrappers with correct default paths
- ✅ **PoS Compatibility**: Fixed geth genesis configuration for v1.15.10 requirements

### 5. File Organization
- ✅ **Clean Structure**: 
  - Genesis files in `/jsonrpc` where scripts expect them
  - Tools and packages in `/simulator` 
  - Runtime data in `.evmd/` and `.geth-data/` (gitignored)
- ✅ **Path Consistency**: All tools use correct relative paths by default

## Current Status 🚀

**Major Progress Achieved - JSON-RPC API Compatibility Testing:**
- **evmd**: http://localhost:8545 (Chain ID: 4221) - FULLY OPERATIONAL
- **Debug APIs**: **16 PASS, 0 FAIL** - 100% success rate for implemented APIs! ✅
- **Overall Status**: **65 PASS, 9 FAIL** (88% success rate)
- **Enhanced Validation**: Real network response format validation implemented

### Latest Session Results (August 7, 2025):

#### ✅ **MAJOR ACHIEVEMENT: Debug API Mastery**
- **Created dedicated debug.go file** with all debug API implementations
- **Enhanced validation with real network data** from working Cosmos EVM testnet
- **Fixed state pruning configuration** (pruning = "nothing") enabling debug APIs
- **Achieved 100% success rate** for all implemented debug APIs (16/16 passing)

#### ✅ **Debug APIs Now Working:**
- debug_traceTransaction ✅ (with callTracer validation)
- debug_traceBlockByHash ✅ (with structure validation)
- debug_traceBlockByNumber ✅
- debug_printBlock, debug_setBlockProfileRate ✅
- debug_setMutexProfileFraction, debug_setGCPercent ✅
- debug_intermediateRoots, debug_mutexProfile ✅
- debug_cpuProfile, debug_goTrace, debug_blockProfile ✅
- debug_gcStats, debug_freeOSMemory, debug_stacks ✅
- debug_memStats ✅

#### ✅ **Enhanced Validation System:**
- **Real network response validation** using actual Cosmos EVM testnet responses
- **Cross-validation** between trace results and transaction receipts
- **Structure validation** for callTracer format (from, gas, gasUsed, to, type fields)
- **Format validation** for hex strings and transaction types
- **Consistency checking** for gas usage matching

#### 🔍 **Remaining Issues Identified:**
1. **net_peerCount** - API works (returns 0) but test framework has type handling issue
2. **8 Personal APIs** - User confirmed these should be SKIPPED (always return false in Cosmos EVM)

## What's Left To Do 📋

### Next Tasks (In Order):

#### 14. **Fix net_peerCount Framework Issue** (CURRENT)
- API works correctly, returns `0` from Cosmos EVM
- Test framework has JSON unmarshaling type mismatch
- Need to debug test validation logic

#### 15. **Skip Personal APIs** 
- Mark 8 personal APIs as SKIPPED instead of FAIL
- User confirmed: Cosmos EVM implements these to always return false
- APIs: personal_lockAccount, personal_sign, personal_sendTransaction, etc.

#### 16. **Complete Final API Coverage**
- Address any remaining eth API failures
- Focus on APIs that should actually work vs. not implemented

#### 17. **Implement Dual Network Comparison** (FUTURE)
- Add geth endpoint for comparison testing
- Implement response comparison logic between evmd and geth
- Handle expected differences as 'passed' cases

## Key File Locations 📁

```
/jsonrpc/
├── exported_genesis.json          # Source cosmos genesis with tx state
├── geth_genesis.json             # Converted geth-compatible genesis  
├── scripts/                      # Network start/stop scripts
│   ├── evmd/start-evmd.sh       # Start evmd (port 8545) - UPDATED with pruning fix
│   └── geth/start-geth.sh       # Start geth (port 8547)
└── simulator/                    # Main simulator codebase
    ├── cmd/                      # CLI tools
    │   ├── stategen/            # Create blockchain state
    │   └── genesis-converter/   # Convert genesis formats
    ├── stategen/                # State generation package  
    ├── genesis/                 # Genesis conversion package
    ├── rpc/
    │   ├── debug.go             # NEW: All debug API implementations with validation
    │   ├── net.go               # Updated net API handlers
    │   ├── eth.go               # Main eth API implementations
    │   └── constant.go          # RPC method name constants
    ├── main.go                  # Updated with debug API handlers
    └── config.yaml              # Simulator configuration
```

## Quick Commands 🛠️

### Start Networks
```bash
# Start evmd
scripts/evmd/start-evmd.sh

# Start geth  
scripts/geth/start-geth.sh
```

### Generate State & Convert Genesis
```bash
# Create initial blockchain state
cd simulator && go run ./cmd/stategen/main.go

# Convert genesis (after stopping evmd and exporting)
cd simulator && go run ./cmd/genesis-converter/main.go
```

### Test Endpoints
```bash
# Test evmd
curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' http://localhost:8545

# Test geth
curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' http://localhost:8547
```

## Technical Notes 📝

### Genesis Conversion Details
- **Accounts Converted**: 6 accounts with proper balance mapping
- **Contract State**: 1 contract (13,516 bytes of code) 
- **Address Mapping**: Cosmos bech32 ↔ Ethereum hex addresses
- **PoS Configuration**: Added `terminalTotalDifficulty: 0` for geth v1.15.10

### Known Working State
- Validator balance: `0x52b79c6188a892aed20170` wei (matches on both chains)
- Chain ID: 4221 (0x107d) on both networks
- Test accounts: All 5 standard accounts from local_node.sh setup

## Latest Technical Achievements 🏆

### Critical Fixes Made:
1. **State Pruning Fix** in `scripts/evmd/start-evmd.sh`:
   ```bash
   # Changed from: pruning = "custom" 
   # To: pruning = "nothing"
   ```
   - **Impact**: Resolved all debug API state access failures

2. **Enhanced Trace Validation** using real testnet responses:
   ```bash
   # Test data from: https://stable-jsonrpc.testnet.chain0.dev/
   # Validates callTracer format: {from, gas, gasUsed, to, type, input, output}
   ```

3. **Proper API Parameter Handling** for profiling APIs:
   ```go
   // Added proper parameters for profiling APIs
   filename := "/tmp/mutex_profile.out"
   duration := 1 // 1 second duration for testing
   ```

## Next Session Notes 🔄

When continuing work:
1. **Current Status**: evmd running with debug APIs fully working (16/16 pass)
2. **Next Priority**: Fix net_peerCount framework type handling issue
3. **Skip personal APIs**: Mark as SKIPPED (not FAIL) since they always return false
4. **Future**: Implement dual network comparison with geth

### Quick Test Command:
```bash
# Run simulator to see current status
cd simulator && go run .

# Expected: 65 PASS, 9 FAIL (with 8 personal APIs to be skipped)
```

---

*Last Updated: August 7, 2025*  
*Current Phase: Debug API Mastery Complete - 88% Success Rate Achieved*  
*Major Milestone: 16/16 Debug APIs Working with Enhanced Validation* ✅